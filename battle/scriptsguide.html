<!DOCTYPE html> 
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<title>Writing Scripts - Battle Arena</title>
		<meta http-equiv="Content-type" content="text/html;charset=UTF-8" />
		<link rel="stylesheet" href="battle.css" />
		<link rel="icon" type="image/x-icon" href="assets/smallIcon.png">
	</head>
	<body>
		<a href="../battle">
			<img id="logo" src="assets/logo.png">
		</a>
		<div id="topImage"><img src="assets/topImage_levelsguide.png"></div>
		<div class="bodyContent">
			<h1>Script Writing Guide</h1>

			<p>
				Custom scripts, NPCs and blocks may need some extra code in order to work properly online. This guide acts as the documentation for the online system.
			</p>

			<h2>Commands System</h2>
			<p>
				Almost all communication between users is done through the commands system.
			</p>
			<p class="codeBlock">
				local onlinePlay = require("scripts/onlinePlay")<br><br>

				<span class="codeComment">-- A command can be created using onlinePlay.createCommand. A unique name and an importance value is given.</span><br>
				local exampleCommand = onlinePlay.createCommand("example", onlinePlay.IMPORTANCE_MAJOR)<br><br>

				<span class="codeComment">-- You can specify what should happen when a command is received by using its onReceive function.</span><br>
				function exampleCommand.onReceive(sourcePlayerIdx, foo,bar)<br>
				&nbsp;&nbsp;&nbsp;&nbsp;<span class="codeComment">-- Your code here.</span></pre><br>
				end<br><br>

				<span class="codeComment">-- You can then send a command like so. The first argument is the index of the player that it will be sent to (0 to send to everyone). Anything after will be directly passed into the onReceive function.</span><br>
				exampleCommand:send(0, foo,bar)<br>
			</p>
			<p>
				The code comments here mostly explain how this system works. When creating a command, it is important that the name given to it is unique. As such, you should try to avoid any overly generic names.
			<p>
				The importance value for a command can be <span class="codeName">onlinePlay.IMPORTANCE_MINOR</span>, <span class="codeName">onlinePlay.IMPORTANCE_MAJOR</span>, or <span class="codeName">onlinePlay.IMPORTANCE_VITAL</span>. Minor should only be used for small, continuous updates, and there is no guarantee that the messages arrive in order or even arrive at all.
			</p>
			<p>
				Major should be used for most events, as it is essentially guaranteed that it will arrive. It is also always processed in order of when it was sent. Vital is very niche and you should never really need it. It is the same as major, but it will freeze the game until it has arrived.
			</p>
			<p>
				While any basic Lua value can be used as an argument to Command:send, more complex types (like NPCs) cannot be sent. See the "encoding" section for more.
			</p>


			<h2>Users</h2>
			<p>
				A "user" represents the concept of someone who is connected to the room. These are similar to players; each user has an associated player, but a player does not necessarily have a user. They are especially useful if you want to do something for everyone who is connected, but don't want to fuss around with the actual player objects.
			</p>
			<p>
				There are the following static methods related to users:
				<table>
					<tr>
						<th>Function</th>
						<th>Returns</th>
						<th>Description</th>
					</tr>
					<tr>
						<td><div class="codeName">onlinePlay.getUsers&ZeroWidthSpace;()</div></td>
						<td>table</td>
						<td>Returns all currently connected users.</td>
					</tr>
					<tr>
						<td><div class="codeName">onlinePlay.getUserByPlayer&ZeroWidthSpace;(&ZeroWidthSpace;playerIdx (number)&ZeroWidthSpace;)</div></td>
						<td>User or nil</td>
						<td>Returns the user associated with the given player index if it exists.</td>
					</tr>
					<tr>
						<td><div class="codeName">onlinePlay.getUserCount&ZeroWidthSpace;()</div></td>
						<td>number</td>
						<td>Returns the amount of users that are currently connected to the room.</td>
					</tr>
				</table>
			</p>

			<p>
				A user has the following instance methods:

				<table>
					<tr>
						<th>Function</th>
						<th>Returns</th>
						<th>Description</th>
					</tr>
					<tr>
						<td><div class="codeName">:disconnect&ZeroWidthSpace;()</div></td>
						<td>nil</td>
						<td>Kicks the given user. Can only be run as a host, and you cannot kick yourself.</td>
					</tr>
				</table>
			</p>
			<p>
				A user has the following fields:

				<table>
					<tr>
						<th>Field</th>
						<th>Type</th>
						<th>Description</th>
					</tr>
					<tr>
						<td><div class="codeName">.playerIdx</div></td>
						<td>number</td>
						<td>The index of the player associated with the user.</td>
					</tr>
					<tr>
						<td><div class="codeName">.lastResponseTime</div></td>
						<td>number</td>
						<td>The local time that the user last responded at. See the timing section of this guide for more.</td>
					</tr>
					<tr>
						<td><div class="codeName">.pingedTime</div></td>
						<td>number</td>
						<td>The local time that the user was last pinged at. See the timing section of this guide for more.</td>
					</tr>
					<tr>
						<td><div class="codeName">.pingCounter</div></td>
						<td>number</td>
						<td>The number of the times that the user has been pinged.</td>
					</tr>
					<tr>
						<td><div class="codeName">.pingValue</div></td>
						<td>number</td>
						<td>The time, in seconds, that it took that the user to respond to the most recent ping. This is displayed in the top right when the chat is open.</td>
					</tr>
					<tr>
						<td><div class="codeName">.isHost</div></td>
						<td>boolean</td>
						<td>True if this user is the host.</td>
					</tr>
					<tr>
						<td><div class="codeName">.isUnresponsive</div></td>
						<td>boolean</td>
						<td>True if it has been several seconds since the user last responded.</td>
					</tr>
				</table>
			</p>


			<h2>Encoding</h2>
			<p>
				In order for data to be sent between users, it must be encoded as a string and then decoded on the receiving end. When using commands, this is done automatically. However, to do this manually, there are the following functions:

				<table>
					<tr>
						<th>Function</th>
						<th>Returns</th>
						<th>Description</th>
					</tr>
					<tr>
						<td><div class="codeName">onlinePlay.encodeValue&ZeroWidthSpace;(&ZeroWidthSpace;type (string), value (any)&ZeroWidthSpace;)</div></td>
						<td>string</td>
						<td>Encodes the given value into a string representation. These encoded strings can be concatenated together.</td>
					</tr>
					<tr>
						<td><div class="codeName">onlinePlay.decodeValue&ZeroWidthSpace;(&ZeroWidthSpace;type (string), encoded (string), start (number or nil)&ZeroWidthSpace;)</div></td>
						<td>any, number</td>
						<td>Decodes a value from a given string and returns it as its first return value. For an encoded string that contains multiple values, the second return value acts as the start position for the next value to decode.</td>
					</tr>
				</table>
			</p>
			<p>
				The type value of these functions can be any of the strings listed below.
				<table>
					<tr>
						<th>Type</th>
						<th>Description</th>
					</tr>
					<tr>
						<td><div class="codeName">number</div></td>
						<td>A floating point number.</td>
					</tr>
					<tr>
						<td><div class="codeName">boolean</div></td>
						<td>A true/false value.</td>
					</tr>
					<tr>
						<td><div class="codeName">nil</div></td>
						<td>A nil value.</td>
					</tr>
					<tr>
						<td><div class="codeName">string</div></td>
						<td>A string. Cannot be longer than 65,535 bytes.</td>
					</tr>
					<tr>
						<td><div class="codeName">table</div></td>
						<td>A Lua table.</td>
					</tr>
					<tr>
						<td><div class="codeName">list</div></td>
						<td>A Lua table whose keys are consecutive numbers, starting at 1. Note that encoding a list is more efficient than a standard table.</td>
					</tr>
					<tr>
						<td><div class="codeName">Vector2</div></td>
						<td>A 2D vector object from the Vector class.</td>
					</tr>
					<tr>
						<td><div class="codeName">Vector3</div></td>
						<td>A 3D vector object from the Vector class.</td>
					</tr>
					<tr>
						<td><div class="codeName">Vector4</div></td>
						<td>A 4D vector object from the Vector class.</td>
					</tr>
					<tr>
						<td><div class="codeName">uint8</div></td>
						<td>An integer ranging between 0 and 255.</td>
					</tr>
					<tr>
						<td><div class="codeName">sint8</div></td>
						<td>An integer ranging between -128 and 127.</td>
					</tr>
					<tr>
						<td><div class="codeName">uint16</div></td>
						<td>An integer ranging between 0 and 65535.</td>
					</tr>
					<tr>
						<td><div class="codeName">sint16</div></td>
						<td>An integer ranging between -32768 and 32767.</td>
					</tr>
					<tr>
						<td><div class="codeName">uint32</div></td>
						<td>An integer ranging between 0 and 4294967295.</td>
					</tr>
					<tr>
						<td><div class="codeName">sint32</div></td>
						<td>An integer ranging between -2147483648 and 2147483647.</td>
					</tr>
					<tr>
						<td><div class="codeName">any</div></td>
						<td>Encodes any other type automatically. May not always pick the most efficient type (for instance, it will pick "number" over the more efficient integer types).</td>
					</tr>
				</table>
			</p>


			<h2>Timing</h2>
			<p>
				There are two main values used to keep track of the current time. <span class="codeName">onlinePlay.localTime</span> counts the amount of time in seconds since the level started. This value is specific to the user running the game; as such, it would not make sense to send this to other users.
			</p>
			<p>
				<span class="codeName">onlinePlay.syncedTime</span> is similar to the local time, but it is synced between players and thusly can be used as a timestamp between players. Note that this value may actually decrease in some situations, so you cannot rely on it always counting upwards.
			</p>
			<p>
				Note that neither of these serve to replace the lunatime class. Rather, they act as another way of timing things in the case that the real time in seconds is important.
			</p>
		</div>

		<img class="background" src="assets/background.png">
	</body>
</html>